name: Deploy to AWS EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          command_timeout: 20m
          script: |
            cd /home/ubuntu/uoft-assistant

            # æ‹‰å–æœ€æ–°ä»£ç 
            git pull origin main

            # æ¿€æ´»è™šæ‹Ÿç¯å¢ƒå¹¶æ›´æ–°ä¾èµ–
            source venv/bin/activate
            pip install -r requirements.txt --upgrade

            # é‡å¯æœåŠ¡
            sudo systemctl restart uoft-assistant

            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            sleep 5

            # æ£€æŸ¥æœåŠ¡çŠ¶æ€
            sudo systemctl status uoft-assistant --no-pager

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # æµ‹è¯•å¥åº·æ£€æŸ¥æ¥å£
            curl -f http://localhost:8000/health || exit 1
            echo "âœ… Deployment successful!"

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          fi
