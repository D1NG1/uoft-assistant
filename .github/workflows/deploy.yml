name: Deploy to AWS EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          command_timeout: 20m
          script: |
            cd /home/ubuntu/uoft-assistant

            # æ‹‰å–æœ€æ–°ä»£ç 
            git pull origin main

            # æ¿€æ´»è™šæ‹Ÿç¯å¢ƒå¹¶æ›´æ–°ä¾èµ–ï¼ˆåªå®‰è£…æ–°çš„æˆ–ç¼ºå¤±çš„åŒ…ï¼‰
            source venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt

            # æ£€æŸ¥å¹¶æ¸…ç†æ—§çš„ ChromaDB æ•°æ®åº“ï¼ˆé¿å…ç‰ˆæœ¬ä¸å…¼å®¹ï¼‰
            if [ -d "chroma_db" ]; then
                echo "æ£€æµ‹åˆ°æ—§çš„ chroma_dbï¼Œåˆ é™¤åå°†è‡ªåŠ¨é‡å»º..."
                rm -rf chroma_db
            fi

            # é‡å¯æœåŠ¡ï¼ˆä¼šè‡ªåŠ¨é‡å»º chroma_dbï¼‰
            sudo systemctl restart uoft-assistant

            # ç­‰å¾…æœåŠ¡å¯åŠ¨ï¼ˆå¦‚æœéœ€è¦é‡å»ºæ•°æ®åº“ï¼Œä¼šéœ€è¦æ›´é•¿æ—¶é—´ï¼‰
            sleep 20

            # æ£€æŸ¥æœåŠ¡çŠ¶æ€
            sudo systemctl status uoft-assistant --no-pager

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨ï¼ˆé‡è¯•æœºåˆ¶ï¼‰
            echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            for i in {1..30}; do
              if curl -f http://localhost:8000/health > /dev/null 2>&1; then
                echo "âœ… æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡ï¼"
                exit 0
              fi
              echo "å°è¯• $i/30: æœåŠ¡è¿˜æœªå°±ç»ªï¼Œç­‰å¾… 2 ç§’..."
              sleep 2
            done

            # å¦‚æœ 30 æ¬¡å°è¯•éƒ½å¤±è´¥ï¼Œè¾“å‡ºè¯¦ç»†ä¿¡æ¯
            echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼ŒæŸ¥çœ‹æœåŠ¡çŠ¶æ€ï¼š"
            sudo systemctl status uoft-assistant --no-pager
            exit 1

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          fi
